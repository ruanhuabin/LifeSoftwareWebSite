package cn.edu.tsinghua.action;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.apache.struts2.ServletActionContext;

import cn.edu.tsinghua.entity.Catagory;
import cn.edu.tsinghua.entity.Post;
import cn.edu.tsinghua.entity.SubCatagory;
import cn.edu.tsinghua.entity.SubSubCatagory;
import cn.edu.tsinghua.service.PostDAO;
import cn.edu.tsinghua.serviceimpl.PostDAOImpl;


public class UserAction extends SuperAction {
	
	private static final Logger logger = Logger.getLogger("UserLogger");
	
	public String listSoftware()
	{
		PostDAO pDAO = new PostDAOImpl();
		List<Post> allPost = pDAO.listAllPost();
		
		request.setAttribute("all_post", allPost);
		
		logger.info("all post info: " + allPost);
		
		
		
		/*
		 * Following code is used for test treeview, it can be delete at any time
		 * */
		
		Catagory c1 = new Catagory();
		c1.setTitle("CryoEM");
		
		List<SubCatagory> c1SubCatagories = new ArrayList<SubCatagory>();
		
		SubCatagory sc1 = new SubCatagory();
		sc1.setSid(0);
		sc1.setTitle("Thunder");
		
		SubCatagory sc2 = new SubCatagory();
		sc2.setSid(1);
		sc2.setTitle("Thunder2");
		
		List<SubSubCatagory> sc2SSCatatory = new ArrayList<SubSubCatagory>();
		SubSubCatagory ssc1 = new SubSubCatagory();
		ssc1.setSsid(11);
		ssc1.setTitle("Thunder2_1");
		
		sc2SSCatatory.add(ssc1);
		
		SubSubCatagory ssc2 = new SubSubCatagory();
		ssc2.setSsid(22);
		ssc2.setTitle("Thunder2_2");
		sc2SSCatatory.add(ssc2);
		
		sc2.setSubSubCatagories(sc2SSCatatory);
		
		
		SubCatagory sc3 = new SubCatagory();
		sc3.setSid(2);
		sc3.setTitle("Thunder3");
		
		c1SubCatagories.add(sc1);
		c1SubCatagories.add(sc2);
		c1SubCatagories.add(sc3);
		
		c1.setSubCatogories(c1SubCatagories);
		
		
		
		Catagory c2 = new Catagory();
		c2.setTitle("protein");
		
		List<SubCatagory> c2SubCatagories = new ArrayList<SubCatagory>();
		
		SubCatagory c2s1 = new SubCatagory();
		c2s1.setSid(0);
		c2s1.setTitle("Quan");
		
		SubCatagory c2s2 = new SubCatagory();
		c2s2.setSid(1);
		c2s2.setTitle("Lipid");
		
		c2SubCatagories.add(c2s1);
		c2SubCatagories.add(c2s2);
		
		c2.setSubCatogories(c2SubCatagories);
		
		List<Catagory> catagories = new ArrayList<Catagory>();
		catagories.add(c1);
		catagories.add(c2);
		
		List<Catagory> catagories2 = getCatatoryResult(allPost);
		
		logger.info("catagories2 = " + catagories2);
		
		request.setAttribute("catagories", catagories2);
		
		
		
		
		
		
		return "list_software_success";
	}
	
	
	private List<Catagory> getCatatoryResult(List<Post> allPost)
	{
		String strCatagories[] = {"CryoEM", "Protein"};
		List<Catagory> catagories = new ArrayList<Catagory>();
		for(String str: strCatagories)
		{
			Catagory c = new Catagory();
			c.setTitle(str);
			
			catagories.add(c);
		}
		
		
		for(Post p: allPost)
		{
			String cName = p.getCatagory();
			String scName = p.getSubCatagory();
			
			Catagory currCatagory = null;
			//Check which catagory this post belongs to
			for(Catagory c: catagories)
			{
				if(cName.equals(c.getTitle()))
				{
					logger.info("Current post: " + post);
					currCatagory = c;
					break;
				}
			}
			
			//current catagory has no subcatagory
			
			if(scName == null || scName.equals(""))
			{				
				SubCatagory sc = new SubCatagory();
				sc.setTitle(p.getTitle());
				sc.setSid(p.getPid());
				currCatagory.getSubCatogories().add(sc);			
			}
			else // This post has subcatagory
			{
				SubCatagory sc = new SubCatagory();
				sc.setTitle(p.getSubCatagory());
				
				SubSubCatagory ssc = new SubSubCatagory();
				ssc.setTitle(p.getTitle());
				ssc.setSsid(p.getPid());				
				sc.getSubSubCatagories().add(ssc);
				
				logger.info("post = " + p);
				logger.info("currCatagory = " + currCatagory);
				logger.info("currCatagory.getSubCatogories = " + currCatagory.getSubCatogories());
				currCatagory.getSubCatogories().add(sc);
				
				
			}
			
			
		}
		return catagories;
	}
	

	
}
